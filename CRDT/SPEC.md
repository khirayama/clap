# 仕様

- 用語
  - 項目
  - インライン
  - テキスト
  - 編集者: ドキュメントの編集者で、デバイスの操作者
  - 共同編集者: 編集者と共に、同じドキュメントを編集する、別デバイスの操作者
  - 選択範囲: 始点と終点を持つ

- 選択範囲
  - a. 閉じている状態。単一項目のみを持ち、始点と終点が等しい。
  - b. インラインを選択している状態。単一項目のみを持ち、始点と終点が違う。
  - c. 単一項目を選択している状態。単一項目のみを持ち、始点と終点を持たない。
  - d. 複数項目を選択している状態。複数項目を持ち、始点と終点を持たない。

- 選択範囲、編集者、共同編集者の状態へ言及する
- ステータスとしてのxは実装完了、-は仕様定義完了

## Actions

- [x] 文字を入力する - insertText
    - 編集者選択範囲始点に任意の文字もしくは文字列を挿入する
    - 編集者選択範囲始点と終点を文字数分後ろへ移動させる
    - 共同編集者がaまたはbの場合
      - 共同編集者の選択範囲始点
        - 編集者と同一インライン上にあり編集者選択範囲始点より後ろにある場合、文字数分後ろへ移動させる
      - 共同編集者の選択範囲終点
        - 編集者と同一インライン上にあり編集者選択範囲始点より後ろにある場合、文字数分後ろへ移動させる

- [x] 文字を削除する - removeChar
  - 編集者選択範囲始点の前の文字を1文字削除
  - 編集者選択範囲始点と終点を1文字分前へ移動させる
  - 共同編集者がaまたはbの場合
    - 共同編集者の選択範囲始点
      - 編集者と同一インライン上にあり編集者選択範囲始点より後ろにある場合、1文字分前へ移動させる
    - 共同編集者の選択範囲終点
      - 編集者と同一インライン上にあり編集者選択範囲始点より後ろにある場合、1文字分前へ移動させる

- [x] 選択範囲文字を削除する - removeText
  - 編集者選択範囲の文字およびインラインを削除
  - 編集者選択範囲終点を始点へ移動させる
  - 共同編集者がaまたはbの場合
    - 共同編集者の選択範囲始点
      - 編集者と同一インライン上にあり編集者選択範囲始点より後ろにある場合、文字数分前(最小値は編集者選択範囲始点)へ移動させる
    - 共同編集者の選択範囲終点
      - 編集者と同一インライン上にあり編集者選択範囲終点より後ろにある場合、文字数分前(最小値は編集者選択範囲始点)へ移動させる

- [x] 文字を削除したときの後処理 - postprocessTextDeletion
  - インラインが同様の装飾が並んだ場合
    - 該当インラインを前インラインに結合する
  - インラインのテキストが空になった場合
    - 削除すると親項目のインラインが空にならない場合
      - インラインを削除する
      - 前インラインがある場合
        - 前インライン末尾に該当選択範囲を移動する
      - 前インラインがない場合
        - 後インライン先頭に該当選択範囲を移動する

- [-] 項目を追加する
  - 編集者選択範囲直後に新規段落項目を追加する
  - 新規段落項目に新規インラインテキストを追加する
  - 新規インラインテキストの先頭に編集者選択範囲を移動させる

- [x] 項目を削除する - removeItems
  - 編集者選択範囲の項目を削除する
  - 次項目がある場合
    - 編集者選択範囲を次項目に移動する
  - 次項目がない場合
    - 編集者選択範囲を前項目に移動する
  - 次項目も前項目もない場合
    - 編集者選択範囲を親項目へ移動する
  - 次項目も前項目も親項目もない場合
    - 編集者選択範囲を外す
  - 共同編集者の選択範囲が単一選択されている、もしくは範囲内の場合
    - 次項目がある場合
      - 共同編集者選択範囲を次項目に移動する
    - 次項目がない場合
      - 共同編集者選択範囲を前項目に移動する
    - 次項目も前項目もない場合
      - 共同編集者選択範囲を親項目へ移動する
    - 次項目も前項目も親項目もない場合
      - 共同編集者選択範囲を外す
  - 共同編集者の選択範囲が複数選択されており、その中に含まれる場合
    - 共同編集者選択範囲から項目を取り除く

- [x] 項目を置換する - removeItems
  - [x] 選択範囲先頭項目以外を削除する
  - [x] 選択範囲先頭項目を段落項目に変更する
  - [x] その段落項目にテキストインラインを追加する
  - [x] 編集者選択範囲をテキストインライン先頭に移動させる
  - [x] そのテキストインラインに任意の文字を追加する
  - [x] 共同編集者選択範囲が削除範囲に先頭に移動させる

- [-] 項目を削除したときの後処理
  - ドキュメントの子項目が空になった場合
    - 「項目を追加する」を適用

- [ ] インラインを分割する
  - 選択範囲位置でインラインを分割する
  - 新規段落項目を作成する
  - 分割されたインラインの後方を新規段落項目に追加する
  - 選択範囲を新規段落項目先頭に移動する

- [x] 項目タイプを変更する - turnInto
  - 項目タイプを変更する
    - 子項目があるが変更先項目タイプに子項目がない場合
      - 子項目を全てアウトデントする
    - 子項目がないが変更先項目タイプに子項目がある場合
      - 空の子項目を追加する
    - インラインがあるが変更先項目タイプにインラインがない場合
      - インラインを削除する
    - インラインがないが変更先項目タイプにインラインがある場合
      - 空のインラインを追加する

- [x] インデントする - indent
  - 上項目がある場合
    - 選択項目を上項目の子項目として最後尾に追加する
    - 選択項目の子項目をすべてその上項目の最後尾に追加する

- [x] アウトデントする - outdent
  - ドキュメントではない親項目がある場合
    - 下項目がある場合
      - 下項目全てを選択項目の子項目にする
    - 親項目の下項目になる

- [ ] 文字を装飾する

- [ ] 文字を非装飾する

## Usecases

- [-] 確定する - enter
  - [-] a
    - 「Actions インラインを分割する」を適用
  - [-] b
    - 「Actions 選択範囲文字を削除する」を適用
    - 「Actions 文字を削除したときの後処理」を適用する
    - 「Actions インラインを分割する」を適用
  - [-] cおよびd
    - 選択範囲を先頭項目の末尾に合わせる

- [x] 更新する - input
  - [x] a
    - 「Actions 文字を入力する」を適用
  - [x] b
    - 「Actions 選択範囲文字を削除する」を適用
    - 「Actions 文字を削除したときの後処理」を適用する
    - 「Actions 文字を入力する」を適用
  - [x] cおよびd
    - 「Actions 項目を置換する」を適用

- [x] インデントする - indent
  - [x] a、bおよびc
    - 「Actions インデントする」を適用
  - [x] d
    - 複数項目に対して「Actions インデントする」を適用

- [x] アウトデントする - outdent
  - [x] a、bおよびc
    - 「Actions アウトデントする」を適用
  - [x] d
    - 複数項目に対して「Actions アウトデントする」を適用

- [ ] 並び替える - sort

- [-] 削除する - remove
  - [-] a
    - [x] 編集者選択範囲始点が項目のインライン先頭の先頭だった場合
      - [x] 段落項目以外の場合
        - 「Actions 項目タイプを変更する」で段落項目へ変換を適用
      - [x] 段落項目の親項目がドキュメントじゃない場合
        - 「Actions アウトデントする」を適用
      - [-] 段落項目の親項目がドキュメントの場合
        - [-] 上項目がインラインを持つ場合
          - 上項目とインラインとして結合する
        - [-] 上項目がインラインを持たない場合
          - 「Actions 項目を削除する」で上項目を削除を適用
          - 「Actions 項目を削除したときの後処理」を適用
    - [x] 編集者選択範囲始点が先頭でない場合
      - 「Actions 文字を削除する」を適用
      - 「Actions 文字を削除したときの後処理」を適用する
  - [x] b
    - 「Actions 選択範囲文字を削除する」を適用
    - 「Actions 文字を削除したときの後処理」を適用する
  - [x] cおよびd
    - 「Actions 項目を削除する」を適用
    - 「Actions 項目を削除したときの後処理」を適用
